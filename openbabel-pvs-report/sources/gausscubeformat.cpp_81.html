
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>gausscubeformat.cpp</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/**********************************************************************</a>
<a name="ln2">gausscubeformat.cpp - Read in Gaussian cube format files.</a>
<a name="ln3"> </a>
<a name="ln4">// Molekel - Molecular Visualization Program</a>
<a name="ln5">// Copyright (C) 2006, 2007 Swiss National Supercomputing Centre (CSCS)</a>
<a name="ln6"> </a>
<a name="ln7"> Some Portions Copyright (c) 2007 by Geoffrey R. Hutchison</a>
<a name="ln8"> Some Portions Copyright (C) 2008 by Marcus D. Hanwell</a>
<a name="ln9"> Some Portions Copyright (C) 2008 by Tim Vandermeersch</a>
<a name="ln10"> </a>
<a name="ln11">This file is part of the Open Babel project.</a>
<a name="ln12">For more information, see &lt;http://openbabel.org/&gt;</a>
<a name="ln13"> </a>
<a name="ln14">This program is free software; you can redistribute it and/or modify</a>
<a name="ln15">it under the terms of the GNU General Public License as published by</a>
<a name="ln16">the Free Software Foundation: either version 2 of the License, or (at</a>
<a name="ln17">your option) any later version.</a>
<a name="ln18"> </a>
<a name="ln19">This program is distributed in the hope that it will be useful,</a>
<a name="ln20">but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln21">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln22">GNU General Public License for more details.</a>
<a name="ln23">***********************************************************************/</a>
<a name="ln24"> </a>
<a name="ln25">#include &lt;sstream&gt;</a>
<a name="ln26">#include &lt;cstdlib&gt;</a>
<a name="ln27"> </a>
<a name="ln28">#include &lt;openbabel/babelconfig.h&gt;</a>
<a name="ln29">#include &lt;openbabel/obmolecformat.h&gt;</a>
<a name="ln30">#include &lt;openbabel/mol.h&gt;</a>
<a name="ln31">#include &lt;openbabel/atom.h&gt;</a>
<a name="ln32">#include &lt;openbabel/bond.h&gt;</a>
<a name="ln33">#include &lt;openbabel/obiter.h&gt;</a>
<a name="ln34">#include &lt;openbabel/elements.h&gt;</a>
<a name="ln35"> </a>
<a name="ln36">#include &lt;openbabel/griddata.h&gt;</a>
<a name="ln37"> </a>
<a name="ln38">using namespace std;</a>
<a name="ln39"> </a>
<a name="ln40">/// @warning seems that every position in cube files has always to be</a>
<a name="ln41">/// multiplied by this constant even if according to:</a>
<a name="ln42">/// reference: https://www.gaussian.com/cubegen/</a>
<a name="ln43">/// &lt;Num points along first axis&gt; &gt; 0 means that the values</a>
<a name="ln44">/// are already in Angstroms.</a>
<a name="ln45">static const double BOHR_TO_ANGSTROM = 0.529177249;</a>
<a name="ln46">static const double ANGSTROM_TO_BOHR = 1.0 / 0.529177249;</a>
<a name="ln47"> </a>
<a name="ln48">namespace OpenBabel</a>
<a name="ln49">{</a>
<a name="ln50"> </a>
<a name="ln51">  class OBGaussianCubeFormat : public OpenBabel::OBMoleculeFormat</a>
<a name="ln52">  {</a>
<a name="ln53">  public:</a>
<a name="ln54">    // Constructor: register 'cube' and &quot;CUBE&quot; format.</a>
<a name="ln55">    OBGaussianCubeFormat()</a>
<a name="ln56">    {</a>
<a name="ln57">        OpenBabel::OBConversion::RegisterFormat( &quot;cube&quot;, this );</a>
<a name="ln58">        OpenBabel::OBConversion::RegisterFormat( &quot;cub&quot;, this );</a>
<a name="ln59">    }</a>
<a name="ln60"> </a>
<a name="ln61">    // Return description.</a>
<a name="ln62">    virtual const char* Description() //required</a>
<a name="ln63">    {</a>
<a name="ln64">        return</a>
<a name="ln65">        &quot;Gaussian cube format\n&quot;</a>
<a name="ln66">        &quot;A grid format for volume data used by Gaussian\n&quot;</a>
<a name="ln67">        &quot;Open Babel supports reading and writing Gaussian cubes, including multiple\n&quot;</a>
<a name="ln68">        &quot;grids in one file.\n\n&quot;</a>
<a name="ln69"> </a>
<a name="ln70">        &quot;Read Options e.g. -as\n&quot;</a>
<a name="ln71">        &quot;  b no bonds\n&quot;</a>
<a name="ln72">        &quot;  s no multiple bonds\n\n&quot;;</a>
<a name="ln73">    }</a>
<a name="ln74"> </a>
<a name="ln75">    // Return a specification url, not really a specification since</a>
<a name="ln76">    // I couldn't find it but close enough.</a>
<a name="ln77">    virtual const char* SpecificationURL()</a>
<a name="ln78">    {</a>
<a name="ln79">        return &quot;https://www.gaussian.com/cubegen/&quot;;</a>
<a name="ln80">    }</a>
<a name="ln81"> </a>
<a name="ln82">    // Return MIME type, NULL in this case.</a>
<a name="ln83">    virtual const char* GetMIMEType() { return nullptr; }</a>
<a name="ln84"> </a>
<a name="ln85">    // Skip to object: used for multi-object file formats.</a>
<a name="ln86">    virtual int SkipObjects( int n, OpenBabel::OBConversion* pConv ) { return 0; }</a>
<a name="ln87"> </a>
<a name="ln88">    virtual unsigned int Flags()</a>
<a name="ln89">    {</a>
<a name="ln90">        return 0;</a>
<a name="ln91">    };</a>
<a name="ln92"> </a>
<a name="ln93">    /// The &quot;API&quot; interface functions</a>
<a name="ln94">    virtual bool ReadMolecule( OpenBabel::OBBase* pOb, OpenBabel::OBConversion* pConv );</a>
<a name="ln95">    /// Write: always returns false right now - read only</a>
<a name="ln96">    virtual bool WriteMolecule( OpenBabel::OBBase* pOb, OpenBabel::OBConversion* pConv );</a>
<a name="ln97"> </a>
<a name="ln98">};</a>
<a name="ln99"> </a>
<a name="ln100">//------------------------------------------------------------------------------</a>
<a name="ln101"> </a>
<a name="ln102">    // Global variable used to register Gaussian cube format.</a>
<a name="ln103">    OBGaussianCubeFormat theGaussianCubeFormat;</a>
<a name="ln104"> </a>
<a name="ln105">//------------------------------------------------------------------------------</a>
<a name="ln106">bool OBGaussianCubeFormat::ReadMolecule( OBBase* pOb, OBConversion* pConv )</a>
<a name="ln107">{</a>
<a name="ln108">    OBMol* pmol = pOb-&gt;CastAndClear&lt;OBMol&gt;();</a>
<a name="ln109">    if (pmol == nullptr)</a>
<a name="ln110">      return false;</a>
<a name="ln111"> </a>
<a name="ln112">    istream&amp; ifs = *pConv-&gt;GetInStream();</a>
<a name="ln113"> </a>
<a name="ln114">    const char* title = pConv-&gt;GetTitle();</a>
<a name="ln115">    char buffer[BUFF_SIZE];</a>
<a name="ln116"> </a>
<a name="ln117">    stringstream errorMsg;</a>
<a name="ln118"> </a>
<a name="ln119">    int nAtoms = 0;</a>
<a name="ln120">    int negAtoms = false;</a>
<a name="ln121"> </a>
<a name="ln122">    int line = 0; // Line counter - help in debugging...</a>
<a name="ln123"> </a>
<a name="ln124">    if (!ifs)</a>
<a name="ln125">      return false; // We are attempting to read past the end of the file</a>
<a name="ln126"> </a>
<a name="ln127">    // The first two lines are comments - and so not needed.</a>
<a name="ln128">    ++line;</a>
<a name="ln129">    if (!ifs.getline(buffer, BUFF_SIZE))</a>
<a name="ln130">    {</a>
<a name="ln131">      obErrorLog.ThrowError(__FUNCTION__,</a>
<a name="ln132">                            &quot;Problem reading the Gaussian cube file: cannot read the first line (title/comments).&quot;, obWarning);</a>
<a name="ln133">      return false;</a>
<a name="ln134">    }</a>
<a name="ln135">    string cubeTitle = buffer; // save for later use</a>
<a name="ln136"> </a>
<a name="ln137">    ++line;</a>
<a name="ln138">    if (!ifs.getline(buffer,BUFF_SIZE))</a>
<a name="ln139">    {</a>
<a name="ln140">      obErrorLog.ThrowError(__FUNCTION__,</a>
<a name="ln141">                            &quot;Problem reading the Gaussian cube file: cannot read the second line (title/comments).&quot;, obWarning);</a>
<a name="ln142">      return false;</a>
<a name="ln143">    }</a>
<a name="ln144"> </a>
<a name="ln145">    // This line contains the number of atoms included in the file followed by</a>
<a name="ln146">    // the position of the origin of the cube.</a>
<a name="ln147">    ++line;</a>
<a name="ln148">    if (!ifs.getline(buffer, BUFF_SIZE))</a>
<a name="ln149">    {</a>
<a name="ln150">      obErrorLog.ThrowError(__FUNCTION__,</a>
<a name="ln151">                            &quot;Problem reading the Gaussian cube file: cannot read the third line. This should contain the number of atoms and the position of the origin of the cube.&quot;, obWarning);</a>
<a name="ln152">      return false;</a>
<a name="ln153">    }</a>
<a name="ln154">    vector&lt;string&gt; vs;</a>
<a name="ln155">    tokenize(vs, buffer);</a>
<a name="ln156">    if (vs.size() &lt; 4)</a>
<a name="ln157">    {</a>
<a name="ln158">      obErrorLog.ThrowError(__FUNCTION__,</a>
<a name="ln159">                            &quot;Problem reading the Gassian cube file: The third line must contain the number of atoms and the origin of the cube.&quot;, obWarning);</a>
<a name="ln160">      return false;</a>
<a name="ln161">    }</a>
<a name="ln162">    char *endptr;</a>
<a name="ln163">    nAtoms = strtol(static_cast&lt;const char*&gt;(vs.at(0).c_str()), &amp;endptr, 10);</a>
<a name="ln164">    if (endptr == static_cast&lt;const char*&gt;(vs.at(0).c_str()))</a>
<a name="ln165">    {</a>
<a name="ln166">      errorMsg &lt;&lt; &quot;Problems reading the Gaussian cube file: &quot;</a>
<a name="ln167">               &lt;&lt; &quot;Could not read line #3.\n&quot;</a>
<a name="ln168">               &lt;&lt; &quot;According to the specification this line should contain &quot;</a>
<a name="ln169">               &lt;&lt; &quot;four entries separated by white space.\n&quot;</a>
<a name="ln170">               &lt;&lt; &quot;OpenBabel could not interpret item #0 as an integer.&quot;;</a>
<a name="ln171">      obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln172">      return false;</a>
<a name="ln173">    }</a>
<a name="ln174">    if (nAtoms &lt; 0)</a>
<a name="ln175">    {</a>
<a name="ln176">      // If the number of atoms is negative it means there is data between</a>
<a name="ln177">      // the atom positions and grid data.</a>
<a name="ln178">      negAtoms = true;</a>
<a name="ln179">      nAtoms *= -1;</a>
<a name="ln180">    }</a>
<a name="ln181">//    cerr &lt;&lt; &quot;Number of atoms: &quot; &lt;&lt; nAtoms &lt;&lt; &quot; Orig: &quot; &lt;&lt; vs.at(0) &lt;&lt; endl;</a>
<a name="ln182">    double x = strtod(static_cast&lt;const char*&gt;(vs.at(1).c_str()), &amp;endptr);</a>
<a name="ln183">    if (endptr == static_cast&lt;const char*&gt;(vs.at(1).c_str()))</a>
<a name="ln184">    {</a>
<a name="ln185">      errorMsg &lt;&lt; &quot;Problems reading the Gaussian cube file: &quot;</a>
<a name="ln186">               &lt;&lt; &quot;Could not read line #3.\n&quot;</a>
<a name="ln187">               &lt;&lt; &quot;According to the specification this line should contain &quot;</a>
<a name="ln188">               &lt;&lt; &quot;four entries separated by white space.\n&quot;</a>
<a name="ln189">               &lt;&lt; &quot;OpenBabel could not interpret item #1 as a double.&quot;;</a>
<a name="ln190">      obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln191">      return false;</a>
<a name="ln192">    }</a>
<a name="ln193">    double y = strtod(static_cast&lt;const char*&gt;(vs.at(2).c_str()), &amp;endptr);</a>
<a name="ln194">    if (endptr == static_cast&lt;const char*&gt;(vs.at(2).c_str()))</a>
<a name="ln195">    {</a>
<a name="ln196">      errorMsg &lt;&lt; &quot;Problems reading the Gaussian cube file: &quot;</a>
<a name="ln197">               &lt;&lt; &quot;Could not read line #3.\n&quot;</a>
<a name="ln198">               &lt;&lt; &quot;According to the specification this line should contain &quot;</a>
<a name="ln199">               &lt;&lt; &quot;four entries separated by white space.\n&quot;</a>
<a name="ln200">               &lt;&lt; &quot;OpenBabel could not interpret item #2 as a double.&quot;;</a>
<a name="ln201">      obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln202">      return false;</a>
<a name="ln203">    }</a>
<a name="ln204">    double z = strtod(static_cast&lt;const char*&gt;(vs.at(3).c_str()), &amp;endptr);</a>
<a name="ln205">    if (endptr == static_cast&lt;const char*&gt;(vs.at(3).c_str()))</a>
<a name="ln206">    {</a>
<a name="ln207">      errorMsg &lt;&lt; &quot;Problems reading the Gaussian cube file: &quot;</a>
<a name="ln208">               &lt;&lt; &quot;Could not read line #3.\n&quot;</a>
<a name="ln209">               &lt;&lt; &quot;According to the specification this line should contain &quot;</a>
<a name="ln210">               &lt;&lt; &quot;four entries separated by white space.\n&quot;</a>
<a name="ln211">               &lt;&lt; &quot;OpenBabel could not interpret item #3 as a double.&quot;;</a>
<a name="ln212">      obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln213">      return false;</a>
<a name="ln214">    }</a>
<a name="ln215">    vector3 origin(x, y, z);</a>
<a name="ln216">    origin *= BOHR_TO_ANGSTROM;</a>
<a name="ln217"> </a>
<a name="ln218">    // The next three lines contain the number of voxels in x, y and z along</a>
<a name="ln219">    // with the three cube cell axes.</a>
<a name="ln220">    vector&lt;int&gt; voxels(3);</a>
<a name="ln221">    vector&lt;vector3&gt; axes(3);</a>
<a name="ln222">    bool angstroms = true;</a>
<a name="ln223">    for (int i = 0; i &lt; 3; i++)</a>
<a name="ln224">    {</a>
<a name="ln225">      ++line;</a>
<a name="ln226">      if (!ifs.getline(buffer, BUFF_SIZE))</a>
<a name="ln227">      {</a>
<a name="ln228">        errorMsg &lt;&lt; &quot;Problem reading the Gaussian cube file: cannot read the &quot;</a>
<a name="ln229">                 &lt;&lt; line &lt;&lt; &quot;line.\nAccording to the specification this line &quot;</a>
<a name="ln230">                 &lt;&lt; &quot;should contain header information on the size of the cube.\n&quot;;</a>
<a name="ln231">        obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln232">        return false;</a>
<a name="ln233">      }</a>
<a name="ln234">      vs.clear();</a>
<a name="ln235">      tokenize(vs, buffer);</a>
<a name="ln236">      if (vs.size() &lt; 4)</a>
<a name="ln237">      {</a>
<a name="ln238">        errorMsg &lt;&lt; &quot;Problem reading the Gaussian cube file: cannot read the &quot;</a>
<a name="ln239">                 &lt;&lt; i+4 &lt;&lt; &quot;line.\nAccording to the specification this line &quot;</a>
<a name="ln240">                 &lt;&lt; &quot;should contain four elements (cube header).\n&quot;;</a>
<a name="ln241">        obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln242">        return false;</a>
<a name="ln243">      }</a>
<a name="ln244">      voxels[i] = strtol(static_cast&lt;const char*&gt;(vs.at(0).c_str()), &amp;endptr, 10);</a>
<a name="ln245">      if (endptr == static_cast&lt;const char*&gt;(vs.at(0).c_str()))</a>
<a name="ln246">      {</a>
<a name="ln247">        errorMsg &lt;&lt; &quot;Problems reading the Gaussian cube file: &quot;</a>
<a name="ln248">                 &lt;&lt; &quot;Could not read line &quot; &lt;&lt; i+4 &lt;&lt; &quot;.\n&quot;</a>
<a name="ln249">                 &lt;&lt; &quot;According to the specification this line should contain &quot;</a>
<a name="ln250">                 &lt;&lt; &quot;four entries separated by white space.\n&quot;</a>
<a name="ln251">                 &lt;&lt; &quot;OpenBabel could not interpret item #0 as an integer.&quot;;</a>
<a name="ln252">        obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln253">        return false;</a>
<a name="ln254">      }</a>
<a name="ln255">      if (voxels[i] &lt; 0)</a>
<a name="ln256">      {</a>
<a name="ln257">        // If the number of voxels is negative then the cube is in Bohr</a>
<a name="ln258">        angstroms = false;</a>
<a name="ln259">        voxels[i] *= -1;</a>
<a name="ln260">      }</a>
<a name="ln261">      x = strtod(static_cast&lt;const char*&gt;(vs.at(1).c_str()), &amp;endptr);</a>
<a name="ln262">      if (endptr == static_cast&lt;const char*&gt;(vs.at(1).c_str()))</a>
<a name="ln263">      {</a>
<a name="ln264">        errorMsg &lt;&lt; &quot;Problems reading the Gaussian cube file: &quot;</a>
<a name="ln265">                 &lt;&lt; &quot;Could not read line &quot; &lt;&lt; i+4 &lt;&lt; &quot;.\n&quot;</a>
<a name="ln266">                 &lt;&lt; &quot;According to the specification this line should contain &quot;</a>
<a name="ln267">                 &lt;&lt; &quot;four entries separated by white space.\n&quot;</a>
<a name="ln268">                 &lt;&lt; &quot;OpenBabel could not interpret item #1 as a double.&quot;;</a>
<a name="ln269">        obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln270">        return false;</a>
<a name="ln271">      }</a>
<a name="ln272">      y = strtod(static_cast&lt;const char*&gt;(vs.at(2).c_str()), &amp;endptr);</a>
<a name="ln273">      if (endptr == static_cast&lt;const char*&gt;(vs.at(2).c_str()))</a>
<a name="ln274">      {</a>
<a name="ln275">        errorMsg &lt;&lt; &quot;Problems reading the Gaussian cube file: &quot;</a>
<a name="ln276">                 &lt;&lt; &quot;Could not read line &quot; &lt;&lt; i+4 &lt;&lt; &quot;.\n&quot;</a>
<a name="ln277">                 &lt;&lt; &quot;According to the specification this line should contain &quot;</a>
<a name="ln278">                 &lt;&lt; &quot;four entries separated by white space.\n&quot;</a>
<a name="ln279">                 &lt;&lt; &quot;OpenBabel could not interpret item #2 as a double.&quot;;</a>
<a name="ln280">        obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln281">        return false;</a>
<a name="ln282">      }</a>
<a name="ln283">      z = strtod(static_cast&lt;const char*&gt;(vs.at(3).c_str()), &amp;endptr);</a>
<a name="ln284">      if (endptr == static_cast&lt;const char*&gt;(vs.at(3).c_str()))</a>
<a name="ln285">      {</a>
<a name="ln286">        errorMsg &lt;&lt; &quot;Problems reading the Gaussian cube file: &quot;</a>
<a name="ln287">                 &lt;&lt; &quot;Could not read line &quot; &lt;&lt; i+4 &lt;&lt; &quot;.\n&quot;</a>
<a name="ln288">                 &lt;&lt; &quot;According to the specification this line should contain &quot;</a>
<a name="ln289">                 &lt;&lt; &quot;four entries separated by white space.\n&quot;</a>
<a name="ln290">                 &lt;&lt; &quot;OpenBabel could not interpret item #3 as a double.&quot;;</a>
<a name="ln291">        obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln292">        return false;</a>
<a name="ln293">      }</a>
<a name="ln294">      axes[i] = vector3(x, y, z);</a>
<a name="ln295">      axes[i] *= BOHR_TO_ANGSTROM;</a>
<a name="ln296">    }</a>
<a name="ln297"> </a>
<a name="ln298">    pmol-&gt;BeginModify();</a>
<a name="ln299">    pmol-&gt;SetDimension(3);</a>
<a name="ln300">    pmol-&gt;ReserveAtoms(nAtoms);</a>
<a name="ln301"> </a>
<a name="ln302">    // Now to read in the atoms contained in the Gaussian cube</a>
<a name="ln303">    for (int i = 0; i &lt; nAtoms; i++)</a>
<a name="ln304">    {</a>
<a name="ln305">      ++line;</a>
<a name="ln306">      if (!ifs.getline(buffer, BUFF_SIZE))</a>
<a name="ln307">      {</a>
<a name="ln308">        errorMsg &lt;&lt; &quot;Problem reading the Gaussian cube file: cannot read the &quot;</a>
<a name="ln309">                 &lt;&lt; line &lt;&lt; &quot;line.\nAccording to the specification this line &quot;</a>
<a name="ln310">                 &lt;&lt; &quot;should contain atomic number and coordinates.\n&quot;;</a>
<a name="ln311">        obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln312">        return false;</a>
<a name="ln313">      }</a>
<a name="ln314">      vs.clear();</a>
<a name="ln315">      tokenize(vs, buffer);</a>
<a name="ln316">      if (vs.size() &lt; 5)</a>
<a name="ln317">      {</a>
<a name="ln318">        errorMsg &lt;&lt; &quot;Problem reading the Gaussian cube file: cannot read the &quot;</a>
<a name="ln319">                 &lt;&lt; line &lt;&lt; &quot;line.\nAccording to the specification this line &quot;</a>
<a name="ln320">                 &lt;&lt; &quot;should contain five elements (atom information).\n&quot;;</a>
<a name="ln321">        obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln322">        return false;</a>
<a name="ln323">      }</a>
<a name="ln324"> </a>
<a name="ln325">      // Only contains atoms - no bonds</a>
<a name="ln326">      OBAtom *atom = pmol-&gt;NewAtom();</a>
<a name="ln327"> </a>
<a name="ln328">      int atomicNum = strtol(static_cast&lt;const char*&gt;(vs.at(0).c_str()), &amp;endptr, 10);</a>
<a name="ln329">      if (endptr == static_cast&lt;const char*&gt;(vs.at(0).c_str()))</a>
<a name="ln330">      {</a>
<a name="ln331">        errorMsg &lt;&lt; &quot;Problems reading the Gaussian cube file: &quot;</a>
<a name="ln332">                 &lt;&lt; &quot;Could not read line &quot; &lt;&lt; line &lt;&lt; &quot;.\n&quot;</a>
<a name="ln333">                 &lt;&lt; &quot;According to the specification this line should contain &quot;</a>
<a name="ln334">                 &lt;&lt; &quot;five entries separated by white space.\n&quot;</a>
<a name="ln335">                 &lt;&lt; &quot;OpenBabel could not interpret item #0 as an integer.&quot;;</a>
<a name="ln336">        obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln337">        return false;</a>
<a name="ln338">      }</a>
<a name="ln339"> </a>
<a name="ln340">      atom-&gt;SetAtomicNum(atomicNum);</a>
<a name="ln341"> </a>
<a name="ln342">      // Read the atom coordinates</a>
<a name="ln343">      x = strtod(static_cast&lt;const char*&gt;(vs.at(2).c_str()), &amp;endptr);</a>
<a name="ln344">      if (endptr == static_cast&lt;const char*&gt;(vs.at(2).c_str()))</a>
<a name="ln345">      {</a>
<a name="ln346">        errorMsg &lt;&lt; &quot;Problems reading the Gaussian cube file: &quot;</a>
<a name="ln347">                 &lt;&lt; &quot;Could not read line &quot; &lt;&lt; line &lt;&lt; &quot;.\n&quot;</a>
<a name="ln348">                 &lt;&lt; &quot;According to the specification this line should contain &quot;</a>
<a name="ln349">                 &lt;&lt; &quot;five entries separated by white space.\n&quot;</a>
<a name="ln350">                 &lt;&lt; &quot;OpenBabel could not interpret item #2 as a double.&quot;;</a>
<a name="ln351">        obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln352">        return false;</a>
<a name="ln353">      }</a>
<a name="ln354">      y = strtod(static_cast&lt;const char*&gt;(vs.at(3).c_str()), &amp;endptr);</a>
<a name="ln355">      if (endptr == static_cast&lt;const char*&gt;(vs.at(3).c_str()))</a>
<a name="ln356">      {</a>
<a name="ln357">        errorMsg &lt;&lt; &quot;Problems reading the Gaussian cube file: &quot;</a>
<a name="ln358">                 &lt;&lt; &quot;Could not read line &quot; &lt;&lt; line &lt;&lt; &quot;.\n&quot;</a>
<a name="ln359">                 &lt;&lt; &quot;According to the specification this line should contain &quot;</a>
<a name="ln360">                 &lt;&lt; &quot;five entries separated by white space.\n&quot;</a>
<a name="ln361">                 &lt;&lt; &quot;OpenBabel could not interpret item #3 as a double.&quot;;</a>
<a name="ln362">        obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln363">        return false;</a>
<a name="ln364">      }</a>
<a name="ln365">      z = strtod(static_cast&lt;const char*&gt;(vs.at(4).c_str()), &amp;endptr);</a>
<a name="ln366">      if (endptr == static_cast&lt;const char*&gt;(vs.at(4).c_str()))</a>
<a name="ln367">      {</a>
<a name="ln368">        errorMsg &lt;&lt; &quot;Problems reading the Gaussian cube file: &quot;</a>
<a name="ln369">                 &lt;&lt; &quot;Could not read line &quot; &lt;&lt; line &lt;&lt; &quot;.\n&quot;</a>
<a name="ln370">                 &lt;&lt; &quot;According to the specification this line should contain &quot;</a>
<a name="ln371">                 &lt;&lt; &quot;five entries separated by white space.\n&quot;</a>
<a name="ln372">                 &lt;&lt; &quot;OpenBabel could not interpret item #4 as a double.&quot;;</a>
<a name="ln373">        obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln374">        return false;</a>
<a name="ln375">      }</a>
<a name="ln376">      // Convert units...</a>
<a name="ln377">      x *= BOHR_TO_ANGSTROM;</a>
<a name="ln378">      y *= BOHR_TO_ANGSTROM;</a>
<a name="ln379">      z *= BOHR_TO_ANGSTROM;</a>
<a name="ln380">      atom-&gt;SetVector(x, y, z);</a>
<a name="ln381">    }</a>
<a name="ln382"> </a>
<a name="ln383">    int nCubes = 1;</a>
<a name="ln384">    vector&lt;OBGridData*&gt; vgd;</a>
<a name="ln385">    // If the number of atoms was negative then there is some data between the</a>
<a name="ln386">    // atom data and the cube data, i.e. we have multiple cubes...</a>
<a name="ln387">    if (negAtoms)</a>
<a name="ln388">    {</a>
<a name="ln389">      ++line;</a>
<a name="ln390">      if (!ifs.getline(buffer, BUFF_SIZE))</a>
<a name="ln391">      {</a>
<a name="ln392">        obErrorLog.ThrowError(__FUNCTION__,</a>
<a name="ln393">                              &quot;Problem reading the Gaussian cube file: cannot read the line between the atom data and cube data.&quot;, obError);</a>
<a name="ln394">        return false;</a>
<a name="ln395">      }</a>
<a name="ln396"> </a>
<a name="ln397">      tokenize(vs, buffer);</a>
<a name="ln398">      if (vs.size() &lt; 1) return false; // timvdm 18/06/2008</a>
<a name="ln399">      nCubes = strtol(static_cast&lt;const char*&gt;(vs.at(0).c_str()), &amp;endptr, 10);</a>
<a name="ln400">      if (endptr == static_cast&lt;const char*&gt;(vs.at(0).c_str()))</a>
<a name="ln401">      {</a>
<a name="ln402">        errorMsg &lt;&lt; &quot;Problems reading the Gaussian cube file: &quot;</a>
<a name="ln403">                 &lt;&lt; &quot;Could not read line &quot; &lt;&lt; line &lt;&lt; &quot;.\n&quot;</a>
<a name="ln404">                 &lt;&lt; &quot;According to the specification this line should contain &quot;</a>
<a name="ln405">                 &lt;&lt; &quot;the number of cubes and a number for each cube (orbital number).\n&quot;</a>
<a name="ln406">                 &lt;&lt; &quot;OpenBabel could not interpret item #0 as an integer.&quot;;</a>
<a name="ln407">        obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln408">        return false;</a>
<a name="ln409">      }</a>
<a name="ln410"> </a>
<a name="ln411">      vgd.reserve(nCubes);</a>
<a name="ln412">      for (unsigned int i = 1; i &lt; vs.size(); ++i)</a>
<a name="ln413">      {</a>
<a name="ln414">        int cubeNumber = strtol(static_cast&lt;const char*&gt;(vs.at(i).c_str()), &amp;endptr, 10);</a>
<a name="ln415">        if (endptr == static_cast&lt;const char*&gt;(vs.at(i).c_str()))</a>
<a name="ln416">        {</a>
<a name="ln417">          errorMsg &lt;&lt; &quot;Problems reading the Gaussian cube file: &quot;</a>
<a name="ln418">                   &lt;&lt; &quot;Could not read line &quot; &lt;&lt; line &lt;&lt; &quot;.\n&quot;</a>
<a name="ln419">                   &lt;&lt; &quot;According to the specification this line should contain &quot;</a>
<a name="ln420">                   &lt;&lt; &quot;the number of cubes and a number for each cube (orbital number).\n&quot;</a>
<a name="ln421">                   &lt;&lt; &quot;OpenBabel could not interpret item #&quot; &lt;&lt; vgd.size()</a>
<a name="ln422">                   &lt;&lt; &quot; as an integer.&quot;;</a>
<a name="ln423">          obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln424">          return false;</a>
<a name="ln425">        }</a>
<a name="ln426">        vgd.push_back(new OBGridData);</a>
<a name="ln427">        stringstream cubeTitle;</a>
<a name="ln428">        cubeTitle &lt;&lt; &quot;MO &quot; &lt;&lt; cubeNumber;</a>
<a name="ln429">        vgd.at(vgd.size()-1)-&gt;SetAttribute(cubeTitle.str().c_str());</a>
<a name="ln430">      }</a>
<a name="ln431">      // Now if we have lots of cubes we need to read in more line(s)</a>
<a name="ln432">      while (vgd.size() &lt; nCubes)</a>
<a name="ln433">      {</a>
<a name="ln434">        ++line;</a>
<a name="ln435">        if (!ifs.getline(buffer, BUFF_SIZE))</a>
<a name="ln436">        {</a>
<a name="ln437">          errorMsg &lt;&lt; &quot;Problem reading the Gaussian cube file: cannot&quot;</a>
<a name="ln438">                   &lt;&lt; &quot; read line &quot; &lt;&lt; line</a>
<a name="ln439">                   &lt;&lt; &quot; of the file. More data was expected.\n&quot;</a>
<a name="ln440">                   &lt;&lt; &quot;Grid MO titles read in = &quot; &lt;&lt; vgd.size()</a>
<a name="ln441">                   &lt;&lt; &quot; and expected number of values = &quot;</a>
<a name="ln442">                   &lt;&lt; nCubes &lt;&lt; endl;</a>
<a name="ln443">          obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obError);</a>
<a name="ln444">          return false;</a>
<a name="ln445">        }</a>
<a name="ln446">        tokenize(vs, buffer);</a>
<a name="ln447">        for (unsigned int i = 0; i &lt; vs.size(); ++i)</a>
<a name="ln448">        {</a>
<a name="ln449">          int cubeNumber = strtol(static_cast&lt;const char*&gt;(vs.at(i).c_str()), &amp;endptr, 10);</a>
<a name="ln450">          if (endptr == static_cast&lt;const char*&gt;(vs.at(i).c_str()))</a>
<a name="ln451">          {</a>
<a name="ln452">            errorMsg &lt;&lt; &quot;Problems reading the Gaussian cube file: &quot;</a>
<a name="ln453">                     &lt;&lt; &quot;Could not read line &quot; &lt;&lt; line &lt;&lt; &quot;.\n&quot;</a>
<a name="ln454">                     &lt;&lt; &quot;According to the specification this line should contain &quot;</a>
<a name="ln455">                     &lt;&lt; &quot;the number of cubes and a number for each cube (orbital number).\n&quot;</a>
<a name="ln456">                     &lt;&lt; &quot;OpenBabel could not interpret item #&quot; &lt;&lt; vgd.size()</a>
<a name="ln457">                     &lt;&lt; &quot; as an integer.&quot;;</a>
<a name="ln458">            obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln459">            return false;</a>
<a name="ln460">          }</a>
<a name="ln461">          vgd.push_back(new OBGridData);</a>
<a name="ln462">          stringstream cubeTitle;</a>
<a name="ln463">          cubeTitle &lt;&lt; &quot;MO &quot; &lt;&lt; cubeNumber;</a>
<a name="ln464">          vgd.at(vgd.size()-1)-&gt;SetAttribute(cubeTitle.str().c_str());</a>
<a name="ln465">        }</a>
<a name="ln466">      }</a>
<a name="ln467">    }</a>
<a name="ln468">    else</a>
<a name="ln469">    {</a>
<a name="ln470">      // only one cube</a>
<a name="ln471">      vgd.push_back(new OBGridData);</a>
<a name="ln472">      vgd.at(0)-&gt;SetAttribute(cubeTitle.c_str());</a>
<a name="ln473">    }</a>
<a name="ln474"> </a>
<a name="ln475">    // get all values as one vector&lt;double&gt;</a>
<a name="ln476">    vector&lt;double&gt; values;</a>
<a name="ln477">    int n = voxels[0]*voxels[1]*voxels[2];</a>
<a name="ln478">    values.reserve(n*nCubes);</a>
<a name="ln479">    while (values.size() &lt; n*nCubes)</a>
<a name="ln480">    {</a>
<a name="ln481">      // Read in values until we have a complete row of data</a>
<a name="ln482">      ++line;</a>
<a name="ln483">      if (!ifs.getline(buffer, BUFF_SIZE))</a>
<a name="ln484">      {</a>
<a name="ln485">        errorMsg &lt;&lt; &quot;Problem reading the Gaussian cube file: cannot&quot;</a>
<a name="ln486">                 &lt;&lt; &quot; read line &quot; &lt;&lt; line</a>
<a name="ln487">                 &lt;&lt; &quot; of the file. More data was expected.\n&quot;</a>
<a name="ln488">                 &lt;&lt; &quot;Values read in = &quot; &lt;&lt; values.size()</a>
<a name="ln489">                 &lt;&lt; &quot; and expected number of values = &quot;</a>
<a name="ln490">                 &lt;&lt; n*nCubes &lt;&lt; endl;</a>
<a name="ln491">        obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obError);</a>
<a name="ln492">        return false;</a>
<a name="ln493">      }</a>
<a name="ln494">      tokenize(vs, buffer);</a>
<a name="ln495">      if (vs.size() == 0)</a>
<a name="ln496">      {</a>
<a name="ln497">        errorMsg &lt;&lt; &quot;Problem reading the Gaussian cube file: cannot&quot;</a>
<a name="ln498">                 &lt;&lt; &quot; read line &quot; &lt;&lt; line</a>
<a name="ln499">                 &lt;&lt; &quot;, there does not appear to be any data in it.\n&quot;</a>
<a name="ln500">                 &lt;&lt; buffer &lt;&lt; &quot;\n&quot;;</a>
<a name="ln501">        obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obError);</a>
<a name="ln502">        return false;</a>
<a name="ln503">      }</a>
<a name="ln504"> </a>
<a name="ln505">      for (unsigned int l = 0; l &lt; vs.size(); ++l)</a>
<a name="ln506">      {</a>
<a name="ln507">        values.push_back(strtod(static_cast&lt;const char*&gt;(vs.at(l).c_str()), &amp;endptr));</a>
<a name="ln508">      }</a>
<a name="ln509">    }</a>
<a name="ln510"> </a>
<a name="ln511">    // translate the vector&lt;double&gt; to vector&lt;vector&lt;double&gt; &gt;</a>
<a name="ln512">    vector&lt;vector&lt;double&gt; &gt; vvd;</a>
<a name="ln513">    vvd.resize(nCubes);</a>
<a name="ln514">    for (unsigned int i = 0; i &lt; values.size(); )</a>
<a name="ln515">    {</a>
<a name="ln516">      for (int j = 0; j &lt; nCubes; ++j, ++i) // foreach cube</a>
<a name="ln517">      {</a>
<a name="ln518">        vvd[j].push_back(values[i]);</a>
<a name="ln519">      }</a>
<a name="ln520">    }</a>
<a name="ln521"> </a>
<a name="ln522">    for (int i = 0; i &lt; nCubes; ++i) // foreach cube</a>
<a name="ln523">    {</a>
<a name="ln524">      vgd[i]-&gt;SetNumberOfPoints(voxels[0], voxels[1], voxels[2]);</a>
<a name="ln525">      vgd[i]-&gt;SetLimits(origin, axes[0], axes[1], axes[2]);</a>
<a name="ln526">      vgd[i]-&gt;SetUnit(angstroms ? OBGridData::ANGSTROM : OBGridData::BOHR);</a>
<a name="ln527">      vgd[i]-&gt;SetOrigin(fileformatInput); // i.e., is this data from a file or determined by Open Babel</a>
<a name="ln528">      vgd[i]-&gt;SetValues(vvd[i]); // set the values</a>
<a name="ln529">      pmol-&gt;SetData(vgd[i]); // store the grids in the OBMol</a>
<a name="ln530">    }</a>
<a name="ln531"> </a>
<a name="ln532">    pmol-&gt;EndModify();</a>
<a name="ln533"> </a>
<a name="ln534">    // clean out any remaining blank lines</a>
<a name="ln535">    std::streampos ipos;</a>
<a name="ln536">    do</a>
<a name="ln537">    {</a>
<a name="ln538">      ipos = ifs.tellg();</a>
<a name="ln539">      ifs.getline(buffer,BUFF_SIZE);</a>
<a name="ln540">    }</a>
<a name="ln541">    while(strlen(buffer) == 0 &amp;&amp; !ifs.eof() );</a>
<a name="ln542">    ifs.seekg(ipos);</a>
<a name="ln543"> </a>
<a name="ln544">    // Connect the dots and guess bond orders</a>
<a name="ln545">    if (!pConv-&gt;IsOption(&quot;b&quot;, OBConversion::INOPTIONS))</a>
<a name="ln546">      pmol-&gt;ConnectTheDots();</a>
<a name="ln547">    if (!pConv-&gt;IsOption(&quot;s&quot;, OBConversion::INOPTIONS) &amp;&amp; !pConv-&gt;IsOption(&quot;b&quot;, OBConversion::INOPTIONS))</a>
<a name="ln548">      pmol-&gt;PerceiveBondOrders();</a>
<a name="ln549"> </a>
<a name="ln550">    pmol-&gt;SetDimension(3); // always a 3D structure</a>
<a name="ln551"> </a>
<a name="ln552">    return true;</a>
<a name="ln553">  }</a>
<a name="ln554"> </a>
<a name="ln555">//------------------------------------------------------------------------------</a>
<a name="ln556">  bool OBGaussianCubeFormat::WriteMolecule(OBBase* pOb, OBConversion* pConv)</a>
<a name="ln557">  {</a>
<a name="ln558">    OBMol* pmol = dynamic_cast&lt;OBMol*&gt;(pOb);</a>
<a name="ln559">    if (pmol == nullptr)</a>
<a name="ln560">      return false;</a>
<a name="ln561"> </a>
<a name="ln562">    ostream &amp;ofs = *pConv-&gt;GetOutStream();</a>
<a name="ln563">    OBMol &amp;mol = *pmol;</a>
<a name="ln564"> </a>
<a name="ln565">    char buffer[BUFF_SIZE];</a>
<a name="ln566">    string str;</a>
<a name="ln567">    stringstream errorMsg;</a>
<a name="ln568"> </a>
<a name="ln569">    // first two lines are comments</a>
<a name="ln570">    str = mol.GetTitle();</a>
<a name="ln571">    if (str.empty())</a>
<a name="ln572">      ofs &lt;&lt; &quot;*****&quot; &lt;&lt; endl;</a>
<a name="ln573">    else</a>
<a name="ln574">      ofs &lt;&lt; str &lt;&lt; endl;</a>
<a name="ln575"> </a>
<a name="ln576">    ofs &lt;&lt; endl; // line 2</a>
<a name="ln577"> </a>
<a name="ln578">    OBGridData *gd = (OBGridData*)mol.GetData(OBGenericDataType::GridData);</a>
<a name="ln579">    if (gd == nullptr) {</a>
<a name="ln580">      errorMsg &lt;&lt; &quot;The molecule has no grid.&quot;;</a>
<a name="ln581">      obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obWarning);</a>
<a name="ln582">      return false;</a>
<a name="ln583">    }</a>
<a name="ln584"> </a>
<a name="ln585">    int nx, ny, nz;</a>
<a name="ln586">    double origin[3], xAxis[3], yAxis[3], zAxis[3];</a>
<a name="ln587">    gd-&gt;GetAxes(xAxis, yAxis, zAxis);</a>
<a name="ln588">    gd-&gt;GetNumberOfPoints(nx, ny, nz);</a>
<a name="ln589">    gd-&gt;GetOriginVector(origin);</a>
<a name="ln590"> </a>
<a name="ln591">    // line 3: number of atoms, origin x y z</a>
<a name="ln592">    snprintf(buffer, BUFF_SIZE,&quot;%5d%12.6f%12.6f%12.6f&quot;, - static_cast&lt;signed int&gt; (mol.NumAtoms()),</a>
<a name="ln593">        origin[0]*ANGSTROM_TO_BOHR, origin[1]*ANGSTROM_TO_BOHR, origin[2]*ANGSTROM_TO_BOHR);</a>
<a name="ln594">    ofs &lt;&lt; buffer &lt;&lt; endl;</a>
<a name="ln595"> </a>
<a name="ln596">    // line 4: number of points x direction, axis x direction x y z</a>
<a name="ln597">    snprintf(buffer, BUFF_SIZE,&quot;%5d%12.6f%12.6f%12.6f&quot;, nx,</a>
<a name="ln598">        xAxis[0]*ANGSTROM_TO_BOHR, xAxis[1]*ANGSTROM_TO_BOHR, xAxis[2]*ANGSTROM_TO_BOHR);</a>
<a name="ln599">    ofs &lt;&lt; buffer &lt;&lt; endl;</a>
<a name="ln600"> </a>
<a name="ln601">    // line 5: number of points y direction, axis y direction x y z</a>
<a name="ln602">    snprintf(buffer, BUFF_SIZE,&quot;%5d%12.6f%12.6f%12.6f&quot;, ny,</a>
<a name="ln603">        yAxis[0]*ANGSTROM_TO_BOHR, yAxis[1]*ANGSTROM_TO_BOHR, yAxis[2]*ANGSTROM_TO_BOHR);</a>
<a name="ln604">    ofs &lt;&lt; buffer &lt;&lt; endl;</a>
<a name="ln605"> </a>
<a name="ln606">    // line 6: number of points z direction, axis z direction x y z</a>
<a name="ln607">    snprintf(buffer, BUFF_SIZE,&quot;%5d%12.6f%12.6f%12.6f&quot;, nz,</a>
<a name="ln608">        zAxis[0]*ANGSTROM_TO_BOHR, zAxis[1]*ANGSTROM_TO_BOHR, zAxis[2]*ANGSTROM_TO_BOHR);</a>
<a name="ln609">    ofs &lt;&lt; buffer &lt;&lt; endl;</a>
<a name="ln610"> </a>
<a name="ln611">    // Atom lines: atomic number, ?, X, Y, Z</a>
<a name="ln612">    FOR_ATOMS_OF_MOL (atom, mol) {</a>
<a name="ln613">      double *coordPtr = atom-&gt;GetCoordinate();</a>
<a name="ln614">      snprintf(buffer, BUFF_SIZE,&quot;%5d%12.6f%12.6f%12.6f%12.6f&quot;, atom-&gt;GetAtomicNum(),</a>
<a name="ln615">          static_cast&lt;double&gt;(atom-&gt;GetAtomicNum()),</a>
<a name="ln616">          coordPtr[0]*ANGSTROM_TO_BOHR, coordPtr[1]*ANGSTROM_TO_BOHR, coordPtr[2]*ANGSTROM_TO_BOHR);</a>
<a name="ln617">      ofs &lt;&lt; buffer &lt;&lt; endl;</a>
<a name="ln618">    }</a>
<a name="ln619"> </a>
<a name="ln620">    vector&lt;OBGenericData*&gt; grids = pmol-&gt;GetAllData(OBGenericDataType::GridData);</a>
<a name="ln621">    snprintf(buffer, BUFF_SIZE,&quot; %5lu&quot;, (unsigned long)grids.size());</a>
<a name="ln622">    ofs &lt;&lt; buffer &lt;&lt; flush;</a>
<a name="ln623">    for (unsigned int l = 1; l &lt;= grids.size(); ++l)</a>
<a name="ln624">    {</a>
<a name="ln625">      snprintf(buffer, BUFF_SIZE,&quot; %3d&quot;, l);</a>
<a name="ln626">      ofs &lt;&lt; buffer &lt;&lt; flush;</a>
<a name="ln627">    }</a>
<a name="ln628">    ofs &lt;&lt; endl;</a>
<a name="ln629"> </a>
<a name="ln630">    for (unsigned int l = 0; l &lt; grids.size(); ++l)</a>
<a name="ln631">    {</a>
<a name="ln632">      gd = static_cast&lt;OBGridData*&gt;(grids[l]);</a>
<a name="ln633">      int mx, my, mz;</a>
<a name="ln634">      gd-&gt;GetNumberOfPoints(mx, my, mz);</a>
<a name="ln635"> </a>
<a name="ln636">      if ((nx != mx) || (ny != my) || (nz != mz))</a>
<a name="ln637">      {</a>
<a name="ln638">          errorMsg &lt;&lt; &quot;Problem writing the Gaussian cube file: cube &quot; &lt;&lt; l</a>
<a name="ln639">                   &lt;&lt; &quot; does not have the same dimentions as cube 0.\n&quot;</a>
<a name="ln640">                   &lt;&lt; &quot;This cube will be skipped.\n&quot;;</a>
<a name="ln641">          obErrorLog.ThrowError(__FUNCTION__, errorMsg.str(), obError);</a>
<a name="ln642">      }</a>
<a name="ln643">    }</a>
<a name="ln644"> </a>
<a name="ln645">    // The cube(s)</a>
<a name="ln646">    double value;</a>
<a name="ln647">    unsigned int count = 1;</a>
<a name="ln648">    for (int i = 0; i &lt; nx; ++i)</a>
<a name="ln649">    {</a>
<a name="ln650">      for (int j = 0; j &lt; ny; ++j)</a>
<a name="ln651">      {</a>
<a name="ln652">        for (int k = 0; k &lt; nz; ++k)</a>
<a name="ln653">        {</a>
<a name="ln654">          // The cube files are stored in staggered z</a>
<a name="ln655">          for (unsigned int l = 0; l &lt; grids.size(); ++l)</a>
<a name="ln656">          {</a>
<a name="ln657">            value = static_cast&lt;OBGridData*&gt;(grids[l])-&gt;GetValue(i, j, k);</a>
<a name="ln658">            snprintf(buffer, BUFF_SIZE,&quot; %12.5E&quot;, value);</a>
<a name="ln659">            if (count % 6 == 0)</a>
<a name="ln660">              ofs &lt;&lt; buffer &lt;&lt; endl;</a>
<a name="ln661">            else</a>
<a name="ln662">              ofs &lt;&lt; buffer;</a>
<a name="ln663">            count++;</a>
<a name="ln664">          }</a>
<a name="ln665">        } // z-axis</a>
<a name="ln666">      } // y-axis</a>
<a name="ln667">    } // x-axis</a>
<a name="ln668"> </a>
<a name="ln669">    return true;</a>
<a name="ln670">  }</a>
<a name="ln671">}</a>

</code></pre>
<div class="balloon" rel="536"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v663/" target="_blank">V663</a> Infinite loop is possible. The 'cin.eof()' condition is insufficient to break from the loop. Consider adding the 'cin.fail()' function call to the conditional expression.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
